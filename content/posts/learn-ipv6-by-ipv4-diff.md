---
title: "通过和 IPv4 对比，学习 Ipv6 "
date: 2022-04-23T20:01:00+08:00
draft: true
toc: true
comments: true
tags:
  - untagged
---

## 背景知识（废弃）

### 网络分层

### 网络接口 和 Mac 地址

MAC 地址（单播、组播、广播地址分类） https://blog.csdn.net/zhagzheguo/article/details/90549369

## IPv6 和 IPv4 对比概述

https://datatracker.ietf.org/doc/html/rfc8200
https://datatracker.ietf.org/doc/html/rfc2460

https://en.wikipedia.org/wiki/IPv6
https://zh.wikipedia.org/wiki/IPv6

https://zhuanlan.zhihu.com/p/71684181
https://www.ibm.com/docs/zh/i/7.2?topic=6-comparison-ipv4-ipv6

https://zhuanlan.zhihu.com/p/64598841
https://zhuanlan.zhihu.com/p/67843942
https://zhuanlan.zhihu.com/p/79633456

## 报文格式

> 参考：[IPv4 和 IPv6 报头格式说明](https://ccie.lol/knowledge-base/ipv4-and-ipv6-packet-header/)

先来观察 IPv4 Packet Header 格式，如下所示（[RFC 791: INTERNET PROTOCOL IP 协议](https://datatracker.ietf.org/doc/html/rfc791) ，关于 IPv4 更多参见： [通过 Linux API 学习网络协议栈（二）IP 协议](/posts/learn-net-proto-stack-by-linux-api-2-ip/)）。

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

先来观察 IPv6 Packet Header 格式，如下所示（[RFC 8200: Internet Protocol, Version 6 (IPv6) Specification](https://datatracker.ietf.org/doc/html/rfc8200)）

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version| Traffic Class |           Flow Label                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Payload Length        |  Next Header  |   Hop Limit   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                         Source Address                        +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                      Destination Address                      +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

* IPv6 最重要的一个目标就是解决 IPv4 地址空间太小的问题，因此 IPv6 的地址长度是 128 位，是 IPv4 的 4 倍。
* 虽然 IPv6 地址长度是 IPv4 的 4 倍，但是报头长度只是 IPv4 的 2 被。从上面对比可以看出，IPv6 的报文格式似乎比 IPv4 的报文格式更简单，字段更少。IPv6将报头分文了两个部分：

    * 固定 40 个字节的基本报头（上图表述的就是基本报头），包含了路由过程所需要的数据；
    * 0 或多个 扩展报头，提供了更好的扩展性（而 IPv4 报文头中的选项字段最多只有40字节）。

* IPv6 报头为定长的 40 bytes，IPv4 报头为不定长。IPv4 首部的选项字段允许 IP 首部被扩展，由此导致数据报首部长度可变，故不能预先确定数据字段从何开始，同时也使路由器处理一个 IP 数据报所需时间差异很大（有的要处理选项，有的不需要）。基于此，IPv6 采用固定 40 字节长度的报头长度（称基本报头）。然后 IPv6 通过扩展报头的选项字段实现类似于 IPv4 的扩展功能，并由 IPv6 基本报头的 `Next Header` 字段指向扩展报头（如果有的话）。路由器不处理扩展报头，提升了路由器转发效率。同时，IPv6 报头字段 64 bit 对齐，能够直接对内存进行存取。
* 字段：IPv4 报头有 14 个字段（带选项和填充字段），基本的 IPv4 报头有 12 个字段；IPv6 报头只有 8 个字段。IPv4 中的 header length(4)、Identifier(16)、Flags(3)、Framented offset(13)、Options(Length variable、used for test)、Padding 这些项在 IPv6 中都没有了。
* 首部检查和：每个路由器上 IPv4 首部检查和都需要重新计算，是一项耗时操作。加之数据链路层和传输层协议已经执行了检验操作，网络传输可靠性提升，所以 IPv6 不进行首部检查和，从而更快速处理 IP 分组。
* 选项和填充：选项由扩展报头处理，填充字段也去掉。

## 地址表示法

> 在计算机看来，网络地址就是一个二进制串，但是人类无法直接记忆和书写二进制串，因此需要定义一套标准的人类可读的地址表示法。

在 IPv4 中，网络地址长度只有 32 位，通常使用点分十进制格式来表示一个 IP 地址，如 `192.168.1.1`，对于改地址所属网段的表示方式，在 IPv4 中有两种方式表示：

* 前缀长度 `192.168.1.1/24` 即 `/24`。
* 子网掩码 `255.255.255.0`。

在 IPv6 中，网络地址长度变成了 128 位，如果仍然使用点分十进制表示，那个就太长了，且不易与 IPv4 的地址区分。因此：

* IPv6地址被表示为以冒号（:）分隔的一连串16比特的十六进制数，每个IPv6地址被分为8组，每组的16比特用4个十六进制数来表示，组和组之间用冒号隔开，比如：`2001:0000:130F:0000:0000:09C0:876A:130B`。
* 为了简化IPv6地址的表示，对于IPv6地址中的 `0` 可以有下面的处理方式：
    * 每组中的前导 `0` 可以省略，即上述地址可写为 `2001:0:130F:0:0:9C0:876A:130B`。
    * 如果地址中包含连续两个或多个均为 `0` 的组，则可以用双冒号 `::` 来代替，即上述地址可写为 `2001:0:130F::9C0:876A:130B`。
* 注意在一个IPv6地址中只能使用一次双冒号 `::`，否则当设备将 `::` 转变为 `0` 以恢复 128 位地址时，将无法确定 `::` 所代表的0的个数。

IPv6 中不在使用子网掩码来表示一个子网，而是使用前缀长度表示：`IPv6地址/前缀长度`，如：`2001:0:130F::9C0:876A:130B/64`。

## 地址分类

在 IPv4 中，地址的分类，除了组播和保留地址外，会按照分配规则（A、B、C 类地址以及 CIDR）进行划分（决定一个组织可以获得多少个 IP 地址，这些 IP 地址组成个网络），然后再分为广播地址和单播地址：

* A 类地址（`0.0.0.0/8 ~ 127.255.255.255/8`）、B 类地址（`128.0.0.0/16 ~ 191.255.255.255/16`）、C 类地址（`192.0.0.0/24 ~ 223.255.255.255/24`）。
    * 无分类编址 CIDR，即在 A、B、C 类地址上再次划分，比如：`192.168.0.0/24` 可以划分为 `192.168.0.0/25` 和 `192.168.0.128/25` 两个子网。
        * 单播地址 `192.168.0.0/25` 的单播地址为 `192.168.0.0 ~ 192.168.0.126`
        * 广播地址 `192.168.0.0/25` 的广播地址为 `192.168.0.127`
* D 类地址（组播）：前缀为 `1110`，地址范围为 `224.0.0.0 ~ 239.255.255.255`（用法参见下文）
* E 类地址（保留）：前缀为 `1111`，地址范围为 `240.0.0.0 ~ 255.255.255.255`

由于 IPv6 地址空间巨大，因此 IPv6 没有强制的分配规则，所以 IPv6 的地址可以分为如下三类：

* 单播地址：除了组播地址外的所有地址。
* 组播地址：`ff00/8`。
* 任播地址：从单播地址空间中进行分配，使用单播地址的格式。

可以看出，IPv6 和 IPv4 相比，添加了任播地址，删除了广播地址。

下面，简单介绍下，单播。单播（unicast）就是点对点的通讯，作为开发人员接触的 99.9% 的场景都是单播。

关于：广播（broadcast）、组播（multicast，又叫多播）、任播（anycast），参见下文专门的章节介绍。

## 常见的保留单播地址

> 保留单播地址指的是：非公网 IP 地址。

在 IPv4 中，常见保留的单播地址，可以分为如下几类：

* 未指定地址：`0.0.0.0/32`
* 本地回环地址 `127.0.0.1/8`
* 链路本地地址：`169.254.0.0/16`
* 私有地址空间（专用网络，私有 IP）：
    * `10.0.0.0/8` （`10.0.0.0 ~ 10.255.255.255	`）
    * `172.16.0.0/12` （`172.16.0.0 ~ 172.31.255.255`）
    * `192.168.0.0/16` （`192.168.0.0 ~ 192.168.255.255	`）

在 IPv6 中，上述地址，也有对应物：

* 未指定地址：`::/32`。
* 本地回环地址 `::1/128`。
* 链路本地地址：`fe80::/16`。
* 私有地址空间（在 IPv6 中叫做 Unique local address）：`fc00::/7`，其中 `fd00::/8` 可使用，`fc00::/8` 未定义。

## 广播

只在 IPv4 中存在，向当前网络内的所有主机发送报文，没有见过其应用场景。

TODO 原理讲一下，和 Mac 地址关系。

## 组播

mDNS 协议的底层原理。

http://www.h3c.com/cn/d_200803/336046_30003_0.htm

* ipv4 组播 https://support.huawei.com/enterprise/zh/doc/EDOC1100105907
* ipv6 组播 https://blog.51cto.com/u_7658423/1337745 https://www.cnblogs.com/mysky007/p/11261559.html
* Mac 和 IP 组播地址转换 https://blog.csdn.net/Johan_Joe_King/article/details/105566111

## 地址解析

* IPv4 是 arp 协议，https://www.cnblogs.com/juankai/p/10315957.html，工作在数据链路层，基于 mac 地址广播。
* IPv6 是 NDP (ICMPv6) 协议，工作在网络层，原理是组播 https://blog.51cto.com/u_7658423/1337745。

https://zhuanlan.zhihu.com/p/451627391

https://zhuanlan.zhihu.com/p/79633456

## 地址作用域

169.254
fe80::/16

https://blog.csdn.net/dog250/article/details/88773892

## 任播

IPv6 新增

## IPv6 和 NAT

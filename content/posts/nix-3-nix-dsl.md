---
title: "Nix 详解（三） nix 领域特定语言"
date: 2023-02-25T20:48:49+08:00
draft: true
toc: true
comments: true
tags:
  - untagged
---

> version: nix-2.14.1

## 概述

为了更好的描述一个包，从源码到制品的过程，nix 设计了一套领域特定语言（DSL），来声明一个包。这个语言就叫做 nix 语言。

nix 是一种特定领域的、纯函数式的、惰性求值的、动态类型的编程语言。

该语言主要的应用场景为：

* 定义一个 nix channel，之前文章多次提到的 nixpkgs 收录的超过 8 万个包，就是通过 nix 语言声明的。
* 在 `shell.nix` 中使用，正如之前文章所讲，其可以为一个项目定义一个可重现的隔离的开发环境。
* 在 NixOS 中，来定义操作系统环境，本系列不多赘述。

## Hello World

`nix-lang-demo/01-hello.nix`

```nix
let
  msg = "hello world";
in msg
```

运行代码，`nix-instantiate --eval nix-lang-demo/01-hello.nix`，输出如下：

```
"hello world"
```

除了直接运行一个 `.nix` 代码文件外。通过实验性的 `nix repl` 命令，可以打开一个 nix 交互式 shell，来交互式的执行 nix 表达式。

## 程序结构

和常规的命令式通用编程语言不同，nix 是一种声明式的表达式语言。

常规的 Go、Java、C 等编程语言，一个程序的入口是一个 main 函数。

在 nix 中，没有一个 main 函数。一个 nix 的程序就是 nix 提供的几种基本结构组合而成的表达式。

在执行一个正确的 nix 程序时，解释器最终会推导出一个且必须推导出一个值出来。这个值，必须是 nix 支持的几种数据类型之一，参见下文。

## 数据类型

nix 的数据类型类似于 JSON，可以分为基本数据类型、列表和属性集。

### 基本数据类型

* 字符串，支持多种表达方式。
    * `"string"` 双引号包裹的字符串，对于特殊字符需使用 `\` 转移，如： `\"`、`\$`、`\n`、`\r`、`\t`。该类字符串支持使用 `${}` 进行插值。和其他语言的 `""` 相比，在 nix 中，该类型字符串支持多行的写法。
    * `''string''` 两个单引号包裹的字符串，支持多行，该类字符串会自动删除每一行相同数目（这个数目为所有行中前导空格数最小的数目，如果第一行紧挨这`''`，则不参与统计）的前导空格。比如：

        ```nix
        ''
          This is the first line.
          This is the second line.
            This is the third line.
        ''
        ```

        等价于

        `"This is the first line.\nThis is the second line.\n  This is the third line.\n"`

        该类型字符串也支持 `${}`进行字符串插值。，对于特殊字符需使用 `''` 转移，如：

        * `'''` 等价于 `"''"`
        * `''$` 等价于 `"$"`
        * `\n` 等价于 `"\\n"`，`''\n` 等价于 `"\n"`
        * `\r` 等价于 `"\\r"`，`''\r` 等价于 `"\r"`
        * `\t` 等价于 `"\\t"`，`''\t` 等价于 `"\t"`

    * 双单引号字符串和双引号字符串相比，有更少的引用，且，在书写多行字符串时，代码格式化的缩进会自动去除，且，有更少的转移字符。因此，在写多行字符串时，建议使用双单引号格式。
    * 最后，符合 [RFC 2396](http://www.ietf.org/rfc/rfc2396.txt) 的 URL 可以不适用引号包裹，可以直接使用。

* 数字，支持且不区分整型和浮点型，格式如 `123`、`123.43`、`.27e13`
* 路径，如 `/bin/sh`、`./abc`、`abc/123`，包含一个斜杠的会被识别为路径类型。nix 会把这些路径都转换为绝对路径。

    nix 也支持 `~/abc` 这种写法。

    nix 还支持一种特殊写法，如 `<nixpkgs>`，nix 在 `NIX_PATH` 环境变量中查找指定名字的路径，当 `NIX_PATH` 不存在时，会在 `~/.nix-defexpr/channels` 中查找。

    路径可以作为字符串插值的符号，如 `"${./foo.txt}"`，针对这种情况，nix 会将路径对应文件或目录复制到 `"/nix/store/<hash>-foo.txt"` 中。（Nix 语言假定在计算 Nix 表达式时所有输入文件都将保持不变。例如，假设您在 nix repl 会话期间使用了内插字符串中的文件路径。稍后在同一会话中，更改文件内容后，再次使用文件路径评估内插字符串可能不会返回新的存储路径，因为 Nix 可能不会重新读取文件内容）

    除了 `<>` 语法外，路径也支持插值，注意，至少要有一个 `/` 出现在插值之前，才会被识别为路径。例如：`a.${foo}/b.${bar}` 会被识别为除法运算而不是路径，因此需要改为 `./a.${foo}/b.${bar}`。

* bool，可选值为 true 或 false。
* null，空值，表示 null。

### 列表

### 属性集

## 命名

## 操作

## 函数

## 库

## 非纯函数

## 推导 (derivation)

https://www.zhihu.com/question/279855101/answer/2023496231

## nixpkgs 分析

## 自定义 channel
